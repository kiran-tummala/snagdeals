{
  "name": "SnagDeals v6 ‚Äî Scrape + Push to API",
  "nodes": [
    {
      "name": "‚è∞ Every 30 Minutes",
      "type": "n8n-nodes-base.scheduleTrigger",
      "position": [200, 400],
      "parameters": {
        "rule": {
          "interval": [{ "field": "minutes", "minutesInterval": 30 }]
        }
      }
    },
    {
      "name": "1a. Scrape SlickDeals RSS",
      "type": "n8n-nodes-base.rssFeedRead",
      "position": [450, 100],
      "parameters": {
        "url": "https://slickdeals.net/newsearch.php?rss=1&forumchoice%5B%5D=9&sort=newest"
      }
    },
    {
      "name": "1b. Scrape DealNews RSS",
      "type": "n8n-nodes-base.rssFeedRead",
      "position": [450, 300],
      "parameters": {
        "url": "https://www.dealnews.com/rss/"
      }
    },
    {
      "name": "1c. Scrape DealsOfAmerica",
      "type": "n8n-nodes-base.httpRequest",
      "position": [450, 500],
      "parameters": {
        "url": "https://www.dealsofamerica.com",
        "method": "GET",
        "responseFormat": "text"
      }
    },
    {
      "name": "1d. Parse DOA HTML",
      "type": "n8n-nodes-base.code",
      "position": [650, 500],
      "parameters": {
        "jsCode": "const html = $input.first().json.data || '';\nconst deals = [];\nconst priceRegex = /\\$(\\d+(?:\\.\\d{2})?)/ ;\n\n// Try multiple patterns to find deals\nconst patterns = [\n  /<a[^>]*>([^<]{15,})<\\/a>/gi,\n  /<h[234][^>]*>([^<]{15,})<\\/h[234]>/gi\n];\n\nfor (const regex of patterns) {\n  let match;\n  while ((match = regex.exec(html)) !== null) {\n    const title = match[1].trim();\n    if (title.length < 15 || title.length > 300) continue;\n    if (!/\\$|%|off|deal|save|sale|free/i.test(title)) continue;\n    \n    const priceMatch = title.match(priceRegex);\n    let store = 'Amazon';\n    const t = title.toLowerCase();\n    if (t.includes('walmart')) store = 'Walmart';\n    else if (t.includes('best buy')) store = 'Best Buy';\n    else if (t.includes('target')) store = 'Target';\n    else if (t.includes('costco')) store = 'Costco';\n    else if (t.includes('home depot')) store = 'Home Depot';\n    else if (t.includes('newegg')) store = 'Newegg';\n    else if (t.includes('ebay')) store = 'eBay';\n    \n    deals.push({\n      title: title.substring(0, 200),\n      price: priceMatch ? parseFloat(priceMatch[1]) : 0,\n      store,\n      source: 'dealsofamerica',\n      source_deal_id: 'doa-' + title.toLowerCase().replace(/[^a-z0-9]/g,'').substring(0,30),\n      scrapedAt: new Date().toISOString()\n    });\n  }\n  if (deals.length > 0) break;\n}\n\nconsole.log(`Parsed ${deals.length} deals from DealsOfAmerica`);\nreturn deals.slice(0, 50).map(d => ({ json: d }));"
      }
    },
    {
      "name": "1e. Scrape SmartSaversUnite",
      "type": "n8n-nodes-base.httpRequest",
      "position": [450, 700],
      "parameters": {
        "url": "https://smartsaversunite.com/",
        "method": "GET",
        "responseFormat": "text"
      }
    },
    {
      "name": "1f. Parse SSU HTML",
      "type": "n8n-nodes-base.code",
      "position": [650, 700],
      "parameters": {
        "jsCode": "const html = $input.first().json.data || '';\nconst deals = [];\nconst regex = /<h[234][^>]*>([^<]+)<\\/h[234]>/gi;\nlet match;\nwhile ((match = regex.exec(html)) !== null) {\n  const title = match[1].trim();\n  if (title.length < 10 || title.length > 300) continue;\n  const priceMatch = title.match(/\\$(\\d+(?:\\.\\d{2})?)/);\n  const store = title.includes('Amazon') ? 'Amazon' : title.includes('Walmart') ? 'Walmart' : title.includes('Target') ? 'Target' : 'Amazon';\n  deals.push({\n    title: title.replace(/@\\w+/g, '').trim().substring(0, 200),\n    price: priceMatch ? parseFloat(priceMatch[1]) : 0,\n    store,\n    source: 'smartsaversunite',\n    source_deal_id: 'ssu-' + title.toLowerCase().replace(/[^a-z0-9]/g,'').substring(0,30),\n    scrapedAt: new Date().toISOString()\n  });\n}\nconsole.log(`Parsed ${deals.length} deals from SSU`);\nreturn deals.slice(0, 50).map(d => ({ json: d }));"
      }
    },
    {
      "name": "2. Normalize All Deals",
      "type": "n8n-nodes-base.code",
      "position": [900, 400],
      "parameters": {
        "jsCode": "const storeColors = {\n  'Amazon':'#ff9900','Walmart':'#0071dc','Target':'#cc0000',\n  'Costco':'#e31837','Best Buy':'#0046be','Home Depot':'#f96302',\n  'Newegg':'#c11f1f','eBay':'#e43137','Nike':'#111',\n  \"Lowe's\":'#004990','Kroger':'#0078d4','default':'#86868b'\n};\nconst catEmojis = {retail:'üì¶',grocery:'üõí',fashion:'üëó',furniture:'üè†',restaurant:'üçî'};\n\nfunction categorize(title) {\n  const t = title.toLowerCase();\n  if (/dress|shirt|shoe|sneaker|jacket|fashion|clothing|apparel/i.test(t)) return 'fashion';\n  if (/sofa|couch|bed|furniture|chair|desk|table|mattress/i.test(t)) return 'furniture';\n  if (/chicken|milk|bread|cheese|meat|beef|grocery|produce|food/i.test(t)) return 'grocery';\n  if (/restaurant|pizza|burger|taco|dine|bogo/i.test(t)) return 'restaurant';\n  return 'retail';\n}\n\nconst allDeals = $input.all().map(item => {\n  const d = item.json;\n  const title = d.title || d.name || d.contentSnippet || '';\n  if (!title || title.length < 10) return null;\n  \n  const price = parseFloat(d.price) || 0;\n  const origPrice = parseFloat(d.originalPrice || d.orig) || 0;\n  const discount = origPrice > 0 && price > 0 ? Math.round((1 - price/origPrice) * 100) : parseInt(d.discount || d.off) || 0;\n  const store = d.store || 'Unknown';\n  const category = categorize(title);\n  const source = d.source || 'slickdeals';\n  \n  // Build source_deal_id for dedup\n  const sourceId = d.source_deal_id || d.guid || d.link || (source + '-' + title.toLowerCase().replace(/[^a-z0-9]/g,'').substring(0,40));\n  \n  return {\n    title: title.substring(0, 200),\n    store,\n    store_color: storeColors[store] || storeColors.default,\n    emoji: catEmojis[category] || 'üì¶',\n    category,\n    price,\n    original_price: origPrice || price * 1.3,\n    discount_percent: discount || Math.floor(Math.random() * 20 + 15),\n    source,\n    source_deal_id: sourceId.substring(0, 100),\n    deal_url: d.link || d.url || null,\n    votes: parseInt(d.votes) || Math.floor(Math.random() * 500 + 50),\n    tags: discount >= 40 ? ['hot'] : [],\n    shipping_info: store === 'Amazon' ? 'Free Prime' : 'Free Ship',\n    country: 'US'\n  };\n}).filter(Boolean);\n\nconsole.log(`Normalized ${allDeals.length} deals`);\nreturn allDeals.map(d => ({ json: d }));"
      }
    },
    {
      "name": "3. Filter & Deduplicate",
      "type": "n8n-nodes-base.code",
      "position": [1100, 400],
      "parameters": {
        "jsCode": "const seen = new Set();\nconst now = new Date();\n\nconst filtered = $input.all().filter(item => {\n  const d = item.json;\n  // Skip expired/dead\n  if (/expired|sold out|oos|out of stock|ended|dead/i.test(d.title)) return false;\n  // Skip too short titles\n  if (d.title.length < 15) return false;\n  // Deduplicate by normalized title\n  const key = d.title.toLowerCase().replace(/[^a-z0-9]/g, '').substring(0, 50);\n  if (seen.has(key)) return false;\n  seen.add(key);\n  return true;\n});\n\nconsole.log(`After filter/dedup: ${filtered.length} deals (from ${$input.all().length})`);\nreturn filtered;"
      }
    },
    {
      "name": "4. Push Deals to API",
      "type": "n8n-nodes-base.httpRequest",
      "position": [1300, 400],
      "parameters": {
        "method": "POST",
        "url": "https://snagdeals.cc/api/deals",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Content-Type", "value": "application/json" },
            { "name": "x-api-key", "value": "={{ $env.API_SECRET || 'snagdeals-api-key-change-me-2026' }}" }
          ]
        },
        "sendBody": true,
        "bodyContentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($input.all().map(item => item.json)) }}"
      },
      "notes": "Pushes all normalized deals to the SnagDeals API. The API handles upsert (update if exists, insert if new) using source + source_deal_id as unique key."
    },
    {
      "name": "5. Log Results",
      "type": "n8n-nodes-base.code",
      "position": [1500, 400],
      "parameters": {
        "jsCode": "const response = $input.first().json;\nconsole.log('API Response:', JSON.stringify(response));\nreturn [{ json: { \n  status: 'complete',\n  apiResponse: response,\n  timestamp: new Date().toISOString()\n}}];"
      }
    }
  ],
  "connections": {
    "‚è∞ Every 30 Minutes": {
      "main": [[
        { "node": "1a. Scrape SlickDeals RSS" },
        { "node": "1b. Scrape DealNews RSS" },
        { "node": "1c. Scrape DealsOfAmerica" },
        { "node": "1e. Scrape SmartSaversUnite" }
      ]]
    },
    "1a. Scrape SlickDeals RSS": {
      "main": [[ { "node": "2. Normalize All Deals" } ]]
    },
    "1b. Scrape DealNews RSS": {
      "main": [[ { "node": "2. Normalize All Deals" } ]]
    },
    "1c. Scrape DealsOfAmerica": {
      "main": [[ { "node": "1d. Parse DOA HTML" } ]]
    },
    "1d. Parse DOA HTML": {
      "main": [[ { "node": "2. Normalize All Deals" } ]]
    },
    "1e. Scrape SmartSaversUnite": {
      "main": [[ { "node": "1f. Parse SSU HTML" } ]]
    },
    "1f. Parse SSU HTML": {
      "main": [[ { "node": "2. Normalize All Deals" } ]]
    },
    "2. Normalize All Deals": {
      "main": [[ { "node": "3. Filter & Deduplicate" } ]]
    },
    "3. Filter & Deduplicate": {
      "main": [[ { "node": "4. Push Deals to API" } ]]
    },
    "4. Push Deals to API": {
      "main": [[ { "node": "5. Log Results" } ]]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "timezone": "America/Chicago"
  },
  "meta": {
    "version": "6.0",
    "description": "Simplified scraper: 4 sources ‚Üí normalize ‚Üí dedup ‚Üí push to API. Social media posting can be added later.",
    "pipeline": "‚è∞ 30min ‚Üí Scrape 4 sources ‚Üí Normalize ‚Üí Dedup ‚Üí POST /api/deals ‚Üí Done"
  }
}
